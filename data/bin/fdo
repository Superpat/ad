#!/usr/bin/env sh
# Pop open an st terminal running fzf to interactively select a file to open
# from the current directory

outfile="$(mktemp /tmp/ad-selection-XXX)"
bufid=$(9p read "ad/buffers/current")
dirname=$(dirname $(9p read "ad/buffers/$bufid/filename"))
st \
  -c "floatTerm" \
  -e zsh -c "cd $dirname && fd | fzf > $outfile" &

fname=$(echo $outfile | entr -panz cat "$outfile" | tr -d '\n')
rm "$outfile"

if [[ -n "$fname" ]]; then
  echo -n "open $fname" | 9p write ad/ctrl
fi
